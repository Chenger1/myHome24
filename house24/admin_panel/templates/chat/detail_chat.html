{% extends 'admin_base.html' %}
{% load static %}

{% block title %}–ß–∞—Ç{% endblock %}

{% block content %}
	<div class="content-wrapper">
		<div class="content-header">
			<div class="container-fluid">
				<div class="row mb-2 border_bottom" style="align-items: center;">
					<div class="col-sm-6">
						<h1 class="m-0">{{ to_user.full_name }}</h1>
					</div><!-- /.col -->
					<div class="col-sm-6">
						<nav aria-label="breadcrumb" class="breadcrumb_pull_right">
							<ol class="breadcrumb">
								<li class="breadcrumb-item"><a href="{% url 'admin_panel:index' %}" style="color: black;">
									<i class="fa fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
								<li class="breadcrumb-item">
									<a href="{% url 'admin_panel:list_chats_admin' %}" style="color: black;">–ß–∞—Ç—ã</a>
								</li>
								<li class="breadcrumb-item active" aria-current="page">–ß–∞—Ç</li>
							</ol>
						</nav>
					</div>
				</div><!-- /.row -->
			</div><!-- /.container-fluid -->
		</div>

		<div class="content">
			<div class="container-fluid" style="height: 80vh;">
				<section class="msger">
					<main class="msger-chat">
						<div class="msg left-msg">
							<div
									class="msg-img"
									style="background-image: url(https://image.flaticon.com/icons/svg/327/327779.svg)"
							></div>

							<div class="msg-bubble">
								<div class="msg-info">
									<div class="msg-info-name">BOT</div>
									<div class="msg-info-time">12:45</div>
								</div>

								<div class="msg-text">
									Hi, welcome to SimpleChat! Go ahead and send me a message. üòÑ
								</div>
							</div>
						</div>

						<div class="msg right-msg">
							<div
									class="msg-img"
									style="background-image: url(https://image.flaticon.com/icons/svg/145/145867.svg)"
							></div>

							<div class="msg-bubble">
								<div class="msg-info">
									<div class="msg-info-name">Sajad</div>
									<div class="msg-info-time">12:46</div>
								</div>

								<div class="msg-text">
									You can change your name in JS section!
								</div>
							</div>
						</div>
					</main>

					<form class="msger-inputarea">
						<input type="text" class="msger-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
						<button type="submit" class="msger-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
					</form>
				</section>
			</div>
		</div>
	</div>
{% endblock %}
{% block script %}
	<script src="{% static 'admin_panel/js/socket_io.js' %}"></script>
	<script>
        const CHAT_PATH = '{{ chat_path }}';
        const CHAT_UUID = '{{ chat.chat_uuid }}';
        const msgerForm = $('.msger-inputarea');
        const msgerInput = $('.msger-input');
        const msgerChat = $('.msger-chat');

        const BOT_MSGS = [
            "Hi, how are you?",
            "Ohh... I can't understand what you trying to say. Sorry!",
            "I like to play games... But I don't know how to play!",
            "Sorry if my answers are not relevant. :))",
            "I feel sleepy! :("
        ];

        // Icons made by Freepik from www.flaticon.com
        {% if to_user.photo %}
            const TO_USER_IMG = "{{ to_user.photo.url }}";
        {% else %}
            const TO_USER_IMG = "";
        {% endif %}
        {% if request.user.photo %}
            const FROM_USER_IMG = "{{ request.user.photo.url }}";
        {% else %}
            const FROM_USER_IMG = "";
        {% endif %}
        const TO_USER_NAME = "{{ to_user.full_name }}";
        const TO_USER_UUID = '{{ to_user.uuid }}';
        const FROM_USER_NAME = "{{ request.user.full_name }}";
        const FROM_USER_UUID  = '{{ request.user.uuid }}';

        $(document).ready(function(){
            const socket = io(CHAT_PATH);

            socket.on('connect', function(){
                socket.emit('connect_event', {'chat_uuid': CHAT_UUID, 'user_uuid': TO_USER_UUID});
            })

            socket.on('client_info_handler', function(data){
                if(data['success'] === true){
                    console.log('Connected')
                }else{
                    console.log('Not connected')
                }
            })

            socket.on('client_message_handler', function(data){
                const msgText = data['text'];
                if(data['from_user'] === FROM_USER_UUID){
                    appendMessage(FROM_USER_NAME, FROM_USER_IMG, 'right', msgText);
                }else{
                    appendMessage(TO_USER_NAME, TO_USER_IMG, "left", msgText);
				}
            })

            $(msgerForm).on('submit', function(event){
                event.preventDefault();
                const msgText = msgerInput.val();
                if (!msgText) return;

                socket.emit('send_message', {'from_user': FROM_USER_UUID, 'to_user': TO_USER_UUID, 'text': msgText});
                msgerInput.val("");
            })

        })

        function appendMessage(name, img, side, text) {
            //   Simple solution for small apps
            const msgHTML = `
    <div class="msg ${side}-msg">
      <div class="msg-img" style="background-image: url(${img})"></div>

      <div class="msg-bubble">
        <div class="msg-info">
          <div class="msg-info-name">${name}</div>
          <div class="msg-info-time">${formatDate(new Date())}</div>
        </div>

        <div class="msg-text">${text}</div>
      </div>
    </div>
  `;

            msgerChat.append(msgHTML);
            msgerChat.scrollTop(msgerChat.scrollTop() + 500);
        }

        function botResponse() {
            const r = random(0, BOT_MSGS.length - 1);
            const msgText = BOT_MSGS[r];
            const delay = msgText.split(" ").length * 100;

            setTimeout(() => {
                appendMessage(TO_USER_NAME, TO_USER_IMG, "left", msgText);
            }, delay);
        }

        // Utils

        function formatDate(date) {
            const h = "0" + date.getHours();
            const m = "0" + date.getMinutes();

            return `${h.slice(-2)}:${m.slice(-2)}`;
        }

	</script>
{% endblock %}
